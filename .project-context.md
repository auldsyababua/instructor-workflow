# Project Context: Instructor Workflow

**Last Updated**: 2025-01-14

## Project Overview

**Project Name**: Instructor Workflow
**Purpose**: Multi-agent development system using Claude Code with enforced role separation and validated handoffs via the instructor library
**Parent Project**: `/srv/projects/traycer-enforcement-framework` - Production Traycer Enforcement Framework implementation
**This Project**: Minimal proof-of-concept implementation to validate IW architecture on PopOS 22.04
**Target Users**: Solo developers building multi-agent systems with strict agent boundaries on PopOS 22.04 Linux

## Terminology

**Project Name**: Instructor Workflow (IW)
**Historical Context**: This project is a refactoring of the Traycer Enforcement Framework (TEF) located at `/srv/projects/traycer-enforcement-framework`.

**Important**: All references in this repository should use "IW" or "Instructor Workflow" when describing this project's architecture, agents, and enforcement layers. "TEF" or "Traycer Enforcement Framework" should only appear when:
1. Referencing the parent project path (`/srv/projects/traycer-enforcement-framework`)
2. Providing historical context about the project's origin
3. Comparing implementations between the two projects

If agents encounter "TEF" terminology in this repository outside these contexts, it indicates outdated documentation that needs updating.

## Linear Configuration

**Workspace**: Not yet configured
**Linear Team**: Not yet configured
**Team ID**: Not yet configured
**Master Dashboard Issue**: Not yet configured

**Note**: Linear integration is optional for this project. IW can operate with file-based coordination and no Linear dependency.

## Repository Information

**Repository Path**: /srv/projects/instructor-workflow
**Primary Branch**: main
**Current Branch**: main

## Tech Stack

**Core Framework**:
- Python 3.9+ (required by instructor)
- instructor library (567-labs/instructor) - Pydantic-validated LLM responses with automatic retry
- Anthropic Claude API via instructor.from_provider()

**Agent System**:
- Claude Code (claude-cli) - Main agent orchestration platform
- tmux - Process isolation for parallel agent sessions
- Directory-scoped configs (.claude/settings.json per agent)
- SubAgent tool restrictions (YAML frontmatter enforcement)

**Observability & Monitoring**:
- Bun v1.3.2 - JavaScript/TypeScript runtime for WebSocket backend
- Vue 3 + Vite v7.2.2 - Real-time observability dashboard frontend
- Traefik v3 - Reverse proxy (http://workhorse.local/observability)
- Grafana - Long-term metrics visualization (http://workhorse.local/grafana, admin/tonto989)
- Prometheus - Metrics collection backend (http://workhorse.local/prom)

**Environment**:
- PopOS 22.04 (Ubuntu-based Linux)
- kitty or alacritry terminal (gnome-terminal has rendering issues)
- Node.js 20+ for npm tooling
- npm installed to user directory (~/.npm-global)

**Documentation Locations**:
- Agent definitions: `agents/*/`
- Shared reference docs: `agents/shared-ref-docs/`
- Skills: `skills/*/`
- Reference materials: `reference/`
- Scratch workspace: `docs/.scratch/`

## Project Standards

**Agent Coordination**:
- Hybrid enforcement: Tool restrictions (Layer 1) + Directory permissions (Layer 2) + Hook validation (Layer 3) + CLAUDE.md directives (Layer 4) + Instructor validation (Layer 5)
- Hook system (Layer 3) VALIDATED WORKING on PopOS 22.04 (2025-11-13) - contrary to initial reports
- No file-based handoffs required - coordination is conversational via Traycer
- Each agent runs as separate Claude Code process in its own directory with isolated configuration

**Agent Role Boundaries**:
- Planning Agent: Read-only coordinator (tools: Read, Grep, Glob, TodoWrite)
- Action Agent: Implementation only (tools: Bash, Read, Write, Edit, Glob, Grep) - FORBIDDEN from test files
- QA Agent: Test creation and validation (tools: Bash, Read, Write, Edit, Glob, Grep) - EXCLUSIVE test ownership
- Research Agent: Information gathering, Linear issue creation
- Tracking Agent: Linear updates, git operations, PR creation

**File Naming Conventions**:
- Agent prompts: `[agent-name]-agent.md` in `agents/[agent-name]/`
- Agent configs: `.claude/settings.json` in agent directory
- Handoff validation: Instructor Pydantic models in `scripts/`
- Scratch notes: `docs/.scratch/[issue-or-topic]/`

**Security Requirements**:
- No hardcoded secrets (use placeholders: `<SECRET>`, `$ENV_VAR`)
- All paths repo-relative (no `/Users/`, `/home/`, `C:\Users\`)
- SSH configs must use `StrictHostKeyChecking yes` (never `no`)
- Hook scripts require absolute paths with `$CLAUDE_PROJECT_DIR`
- Security validation before commits

**IW Enforcement Architecture** (PopOS 22.04 Hybrid Approach):

**Layer 1 - SubAgent Tool Restrictions** (Most Reliable):
- YAML frontmatter in agent .md files: `tools: Read, Grep, Glob`
- Enforced at API level before Claude attempts operations
- Planning Agent restricted to read-only tools
- Test file access controlled via tool restrictions

**Layer 2 - Directory-Scoped Configurations** (Works):
- Each agent workspace: `agents/<agent-name>/`
- Separate `.claude/settings.json` per agent defining permissions
- Launch pattern: `cd agents/planning && claude --add-dir /project`
- Config loads from agent directory, project files remain accessible

**Layer 3 - Hook-Based Validation** (VALIDATED WORKING):
- PreToolUse hooks successfully block violations on PopOS 22.04
- Exit code 2 blocks operations reliably
- Auto-deny.py provides helpful feedback suggesting agent spawning
- Validated 2025-11-13: 100% success rate in testing
- Path matching works with absolute paths (use string containment, not patterns)
- Use with `--dangerously-skip-permissions` to skip prompts while enforcing via hooks

**Layer 4 - CLAUDE.md Behavioral Directives** (Reinforcement):
- Emphatic instructions in agent CLAUDE.md files
- Critical boundary statements prefixed with ‚ö†Ô∏è
- Behavioral reinforcement when enforcement layers fail

**Layer 5 - Instructor Validation** (Structural):
- Pydantic models validate handoff JSON structure
- Automatic retry on validation failures (1-3 retries)
- Field validators check agent names, file existence, path validity
- Model validators ensure cross-field consistency

**Process Management**:
- tmux-based agent spawning (not direct terminal spawning)
- Each agent in separate tmux session: `tmux new-session -d -s tef-<agent-name>`
- Monitor via: `tmux list-sessions | grep tef-`
- Reliable environment inheritance and process isolation

**Known Limitations** (PopOS 22.04):
- Per-agent MCP isolation NOT SUPPORTED (shared MCP with logical boundaries)
- gnome-terminal has rendering issues (use kitty/alacritty instead)
- Hook path matching requires string containment (`'handoffs/' in path`), not pattern matching (`path.startswith('handoffs/')`)
- Hooks receive absolute paths, not relative paths

## Deprecated Technologies

**None yet** - Update this section when deprecated tech is identified.

**Format for entries**:
```markdown
- ‚ùå WRONG: [deprecated technology/pattern with example]
  ‚úÖ RIGHT: [correct approach with example]
  WHY: [brief explanation of why change was needed]
  WHEN CORRECTED: YYYY-MM-DD
```

## Recurring Lessons & Patterns

**Enforcement Strategy Evolution**:
- Initial assumption: Hooks unreliable on Ubuntu-based systems (based on GitHub issues)
- Testing revealed: Hooks work perfectly on PopOS 22.04 with Claude Code v2.0.17
- Solution: Multi-layer enforcement with hooks providing auto-deny + teaching feedback
- Learning: Always validate assumptions empirically - documentation may be outdated or system-specific

**Agent Spawning Patterns**:
- Direct terminal spawning unreliable on Linux (alias-based spawning fails)
- tmux-based process management works reliably across all tested environments
- Pattern: `tmux new-session -d -s tef-<agent> "cd ~/tef/agents/<agent> && claude"`
- Monitoring: `tmux list-sessions` provides visibility into active agents

**MCP Configuration Reality**:
- Documentation suggests per-workspace MCP isolation
- Reality: MCP servers are process-level, not workspace-level
- Workaround: Shared MCP config with logical tool filtering via SubAgent restrictions
- Architecture prepared for eventual MCP isolation when feature ships

**Security Architecture Decisions** (2025-01-14):
- **Attack Vector Identified**: MCP-scraped forum content creates untrusted input path for Planning Agent
- **Solution**: 5-layer defense-in-depth validation architecture (input sanitization ‚Üí Pydantic ‚Üí semantic validation ‚Üí rate limiting ‚Üí audit logging)
- **MVP Approach**: Fail-fast validation (no auto-retry) with code comments documenting future retry logic
- **Rate Limiting**: Per-capability buckets (Frontend: 10/min, Backend: 10/min - separate limits prevent resource starvation)
- **Audit Strategy**: PII-redacted JSON logs, 90-day retention for security forensics
- **Observability**: Dual dashboard strategy (WebSocket real-time + Grafana long-term metrics)

## Common Mistakes

**DO NOT**:
- ‚ùå Use pattern matching for paths in hooks (use string containment: `'handoffs/' in path`)
- ‚ùå Use direct terminal spawning for agents (unreliable on Linux, use tmux)
- ‚ùå Assume per-agent MCP isolation works (not supported, use shared MCP with tool filtering)
- ‚ùå Expect relative paths in hooks (hooks receive absolute paths)
- ‚ùå Install npm with sudo (creates permission issues, use user directory)
- ‚ùå Use gnome-terminal for agent sessions (rendering issues, use kitty/alacritty)

**DO**:
- ‚úÖ Use hooks for auto-deny with teaching feedback (validated working on PopOS 22.04)
- ‚úÖ Use string containment for path matching in hooks (`'handoffs/' in path`)
- ‚úÖ Launch with `--dangerously-skip-permissions` to skip prompts while enforcing via hooks
- ‚úÖ Spawn agents via tmux sessions for reliable process isolation
- ‚úÖ Use absolute paths in hook command configuration (settings.json)
- ‚úÖ Set `chmod +x` on hook scripts before use
- ‚úÖ Configure npm to user directory: `npm config set prefix '~/.npm-global'`
- ‚úÖ Use kitty or alacritty terminal emulators on PopOS
- ‚úÖ Parse hook context from stdin JSON, not environment variables

## Installation Notes

**For New Developers**:

1. **Environment Setup** (PopOS 22.04):
```bash
# Configure npm user directory (NEVER use sudo)
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# Install Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Set environment variables
cat >> ~/.bashrc << 'EOF'
export TERM=xterm-256color          # Prevents input lag
export LC_ALL=C.UTF-8                # Character encoding
export ANTHROPIC_API_KEY="<your-key>"
export DISABLE_AUTO_UPDATE=true      # Prevents mid-session updates
EOF
source ~/.bashrc
```

2. **Python Dependencies**:
```bash
# Install Python 3.9+ if needed
sudo apt install python3.9 python3-pip

# Install project dependencies
pip install -r requirements.txt
# Or: pip install instructor
```

3. **Terminal Emulator** (if gnome-terminal has issues):
```bash
# Install kitty (recommended)
sudo apt install kitty

# Or download alacritty from releases
# Both have no reported issues on Ubuntu-based systems
```

4. **Verify Setup**:
```bash
# Check node/npm installation
node --version  # Should show v20.x.x
npm --version   # Should work without sudo

# Check Python/instructor
python3 --version
python3 -c "import instructor; print('Instructor installed')"

# Verify environment variables
echo $ANTHROPIC_API_KEY  # Should show your key
echo $TERM               # Should show xterm-256color
```

**Instructor Configuration**:
- Python client wraps Anthropic API: `instructor.from_provider("anthropic/claude-3-haiku-20240307")`
- Automatic retry on validation failures (configure with `max_retries=3`)
- No Linux-specific setup required (pure Python, no platform dependencies)

**Claude Code Configuration**:
- Agent workspaces: `agents/<agent-name>/.claude/settings.json`
- Hook scripts: `agents/<agent-name>/.claude/hooks/` (use absolute paths)
- Global CLAUDE.md: Project root (inherited by all agents)
- Agent-specific CLAUDE.md: `agents/<agent-name>/CLAUDE.md` (overrides/extends)

**Hook Setup** (production enforcement layer):
```bash
# Make hook scripts executable
chmod +x agents/planning/.claude/hooks/auto-deny.py

# Launch Planning Agent with hooks enabled
cd /srv/projects/instructor-workflow/agents/planning
claude --add-dir /srv/projects/instructor-workflow --dangerously-skip-permissions

# Test hook blocking manually
echo '{"tool_name":"Write","tool_input":{"file_path":"src/test.py"}}' | agents/planning/.claude/hooks/auto-deny.py
# Expected: Exit code 2, message about spawning devops-agent
```

**tmux Agent Spawning**:
```bash
# Create spawn script
cat > tef-launch.sh << 'EOF'
#!/bin/bash
tmux new-session -d -s tef-planning "cd ~/tef/agents/planning && claude"
tmux new-session -d -s tef-action "cd ~/tef/agents/action && claude"
tmux new-session -d -s tef-qa "cd ~/tef/agents/qa && claude"
echo "Agents spawned. Attach with: tmux attach -t tef-planning"
EOF
chmod +x tef-launch.sh
```

---

**Project Status**: Layer 5 security hardening in progress - prompt injection defense + observability integration

**Completed**:
1. ‚úÖ Directory structure for IW agents created
2. ‚úÖ Hook-based enforcement validated working on PopOS 22.04
3. ‚úÖ auto-deny.py hook with teaching feedback implemented
4. ‚úÖ Path matching fixed (string containment vs pattern matching)
5. ‚úÖ Test violation files cleaned up
6. ‚úÖ Instructor handoff validation (Pydantic models) implemented and documented
7. ‚úÖ Layer 5 integration added to Planning Agent documentation
8. ‚úÖ Observability dashboard deployed (Traefik + Bun + Vue) - http://workhorse.local/observability
9. ‚úÖ Research completed: Instructor integration security hardening (1,520 lines)

**In Progress** (2025-01-14):
1. üîÑ Layer 5 security enhancements (prompt injection detection, capability constraints, rate limiting)
2. üîÑ ValidatedAgentSpawner wrapper implementation (fail-fast MVP)
3. üîÑ PII-redacted audit logging (90-day forensics trail)
4. üîÑ Grafana metrics integration (validation success rate, latency tracking)

**Framework**: Instructor Workflow (IW)
**Research Date**: 2025-11-12
**Verified Patterns**: mkXultra/claude_code_setup, claude_code_agent_farm, claude-squad

---

## IW Enforcement Validation Results (2025-11-13)

**Validation Date**: 2025-11-13
**System**: PopOS 22.04, Claude Code v2.0.17
**Agent Tested**: Planning Agent

**Test Results**:
- ‚úÖ Layer 3 (Hooks) FULLY FUNCTIONAL - contrary to GitHub issues suggesting unreliability
- ‚úÖ PreToolUse hooks execute reliably with 100% success rate
- ‚úÖ Exit code 2 blocks operations correctly
- ‚úÖ Auto-deny.py provides helpful teaching feedback
- ‚úÖ Path matching works with absolute paths using string containment

**Critical Bug Fixed**:
- Pattern matching `path.startswith('handoffs/')` failed with absolute paths
- Solution: String containment `'handoffs/' in path` works with any path format

**Enforcement Configuration**:
- Launch: `claude --add-dir /srv/projects/instructor-workflow --dangerously-skip-permissions`
- Hook: `agents/planning/.claude/hooks/auto-deny.py`
- Allowed: Read, Grep, Glob, TodoWrite, Task, Write(handoffs/**), Write(.project-context.md)
- Denied: Edit (all), Write(src/**), Write(agents/**), Write(scripts/**), Bash(dangerous commands)

**Conclusion**: IW architecture viable on PopOS 22.04 with hook-based enforcement as primary layer.
